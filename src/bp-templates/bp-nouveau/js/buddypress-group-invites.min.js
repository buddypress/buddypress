window.wp=window.wp||{},window.bp=window.bp||{},function(e,i){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.GroupInvites={start:function(){this.scope=null,this.views=new Backbone.Collection,this.navItems=new Backbone.Collection,this.users=new bp.Collections.Users,this.invites=this.users.clone(),this.setupNav(),this.setupLoops(),this.displayFeedback(BP_Nouveau.group_invites.loading,"loading"),this.users.on("change:selected",this.addInvite,this),this.invites.on("change:selected",this.manageInvite,this),this.invites.on("add",this.invitesNav,this),this.invites.on("reset",this.hideInviteNav,this)},setupNav:function(){var e;this.nav=new bp.Views.invitesNav({collection:this.navItems}),_.each(BP_Nouveau.group_invites.nav,function(i,t){_.isObject(i)&&(e=0,0===t&&(this.scope=i.id,e=1),this.navItems.add({id:i.id,name:i.caption,href:"#",active:e,hide:_.isUndefined(i.hide)?0:i.hide}))},this),this.nav.inject(".bp-invites-nav"),this.nav.on("bp-invites:confirm",this.loadConfirmView,this),this.nav.on("bp-invites:loops",this.setupLoops,this)},setupLoops:function(e){var i;e=e||this.scope,this.clearViews(),e!==this.scope&&this.displayFeedback(BP_Nouveau.group_invites.loading,"loading"),this.scope=e,i=new bp.Views.inviteUsers({collection:this.users,scope:e}),this.views.add({id:"users",view:i}),i.inject(".bp-invites-content"),this.displayFilters(this.users)},displayFilters:function(e){var i;this.filters=new Backbone.Model({page:1,total_page:0,search_terms:"",scope:this.scope}),i=new bp.Views.inviteFilters({model:this.filters,users:e}),this.views.add({id:"filters",view:i}),i.inject(".bp-invites-filters")},removeFeedback:function(){var e;_.isUndefined(this.views.get("feedback"))||((e=this.views.get("feedback")).get("view").remove(),this.views.remove({id:"feedback",view:e}))},displayFeedback:function(e,i){var t;this.removeFeedback(),e&&(t=new bp.Views.Feedback({value:e,type:i||"info"}),this.views.add({id:"feedback",view:t}),t.inject(".bp-invites-feedback"))},addInvite:function(e){if(!0===e.get("selected"))this.invites.add(e);else{var i=this.invites.get(e.get("id"));!0===i.get("selected")&&this.invites.remove(i)}},manageInvite:function(e){var i=this.users.get(e.get("id"));i&&i.set("selected",!1),this.invites.remove(e),this.invites.length||this.invites.reset()},invitesNav:function(){this.navItems.get("invites").set({active:0,hide:0})},hideInviteNav:function(){this.navItems.get("invites").set({active:0,hide:1})},clearViews:function(){_.isUndefined(this.views.models)||(_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset())},loadConfirmView:function(){this.clearViews(),this.displayFeedback(BP_Nouveau.group_invites.invites_form,"help");var e=new bp.Views.invitesEditor({collection:this.invites});this.views.add({id:"invites",view:e}),e.inject(".bp-invites-content")}},bp.Models.User=Backbone.Model.extend({defaults:{id:0,avatar:"",name:"",selected:!1}}),bp.Collections.Users=Backbone.Collection.extend({model:bp.Models.User,initialize:function(){this.options={page:1,total_page:0,group_id:BP_Nouveau.group_invites.group_id}},sync:function(e,i,t){return t=t||{},t.context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.groups,this.options.group_id&&(t.data.group_id=this.options.group_id),"read"===e?(t.data=_.extend(t.data,{action:"groups_get_group_potential_invites"}),bp.ajax.send(t)):"create"===e?(t.data=_.extend(t.data,{action:"groups_send_group_invites",_wpnonce:BP_Nouveau.group_invites.nonces.send_invites}),i&&(t.data.users=i),bp.ajax.send(t)):"delete"===e?(t.data=_.extend(t.data,{action:"groups_delete_group_invite",_wpnonce:BP_Nouveau.group_invites.nonces.uninvite}),i&&(t.data.user=i),bp.ajax.send(t)):void 0},parse:function(e){return _.isArray(e.users)||(e.users=[e.users]),_.each(e.users,function(i,t){_.isNull(i)||(e.users[t].id=i.id,e.users[t].avatar=i.avatar,e.users[t].name=i.name)}),_.isUndefined(e.meta)||(this.options.page=e.meta.page,this.options.total_page=e.meta.total_page),e.users}}),bp.Nouveau.GroupInvites.View=bp.Backbone.View.extend({inject:function(e){this.render(),i(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),bp.Views.Feedback=bp.Nouveau.GroupInvites.View.extend({tagName:"div",className:"bp-invites-feedback",initialize:function(){this.value=this.options.value,this.options.type&&(this.el.className+=" "+this.options.type)},render:function(){return this.$el.html(this.value),this}}),bp.Views.invitesNav=bp.Nouveau.GroupInvites.View.extend({tagName:"ul",events:{"click .bp-invites-nav-item":"toggleView"},initialize:function(){this.collection.on("add",this.outputNav,this),this.collection.on("change:hide",this.showHideNavItem,this)},outputNav:function(e){1!==e.get("hide")&&this.views.add(new bp.Views.invitesNavItem({model:e}))},showHideNavItem:function(e){var i=null;_.each(this.views._views[""],function(t){1===t.model.get("hide")&&t.remove(),e.get("id")===t.model.get("id")&&(i=!0)}),_.isBoolean(i)||(e.set("invites_count",bp.Nouveau.GroupInvites.invites.length),this.outputNav(e))},toggleView:function(e){var t=i(e.target);e.preventDefault(),t.data("nav")||"SPAN"!==e.target.tagName||(t=i(e.target).parent());var s=t.data("nav");_.each(this.collection.models,function(e){e.id===s?(e.set("active",1),"invites"===e.id?this.trigger("bp-invites:confirm"):this.trigger("bp-invites:loops",e.id)):1!==e.get("hide")&&e.set("active",0)},this)}}),bp.Views.invitesNavItem=bp.Nouveau.GroupInvites.View.extend({tagName:"li",template:bp.template("bp-invites-nav"),initialize:function(){1===this.model.get("active")&&(this.el.className+=" current"),"invites"===this.model.get("id")&&(this.el.className+=" dynamic"),"invited"===this.model.get("id")&&(this.el.className+=" pending"),this.model.on("change:active",this.toggleClass,this),this.on("ready",this.updateCount,this),bp.Nouveau.GroupInvites.invites.on("add",this.updateCount,this),bp.Nouveau.GroupInvites.invites.on("remove",this.updateCount,this)},updateCount:function(e,t){if("invites"===this.model.get("id")){var s=_.isUndefined(t)?this.model.get("invites_count"):t.models.length;i(this.el).find("span").length?i(this.el).find("span").html(s):i(this.el).find("a").append(i("<span></span>").html(s))}},toggleClass:function(e){0===e.get("active")?i(this.el).removeClass("current"):i(this.el).addClass("current")}}),bp.Views.Pagination=bp.Nouveau.GroupInvites.View.extend({tagName:"li",className:"last",template:bp.template("bp-invites-paginate")}),bp.Views.inviteFilters=bp.Nouveau.GroupInvites.View.extend({tagName:"div",template:bp.template("bp-invites-filters"),events:{"focus #group_invites_search":"displaySrcBtn","blur #group_invites_search":"hideSrcBtn","search #group_invites_search":"resetSearchTerms","submit #group_invites_search_form":"setSearchTerms","click #bp-invites-next-page":"nextPage","click #bp-invites-prev-page":"prevPage"},initialize:function(){this.model.on("change",this.filterUsers,this),this.options.users.on("sync",this.addPaginatation,this)},addPaginatation:function(e){_.each(this.views._views[""],function(e){e.remove()}),this.views.add(new bp.Views.Pagination({model:new Backbone.Model(e.options)}))},filterUsers:function(){bp.Nouveau.GroupInvites.displayFeedback(BP_Nouveau.group_invites.loading,"loading"),this.options.users.reset(),this.options.users.fetch({data:_.pick(this.model.attributes,["scope","search_terms","page"]),success:this.usersFiltered,error:this.usersFilterError})},usersFiltered:function(){bp.Nouveau.GroupInvites.removeFeedback()},usersFilterError:function(e,i){bp.Nouveau.GroupInvites.displayFeedback(i.feedback,"error")},displaySrcBtn:function(e){e.preventDefault(),i(e.target).closest("form").find("[type=submit]").addClass("bp-show")},hideSrcBtn:function(e){e.preventDefault(),i(e.target).val()||i(e.target).closest("form").find("[type=submit]").addClass("bp-hide").removeClass("bp-show")},resetSearchTerms:function(e){e.preventDefault(),i(e.target).val()?i(e.target).closest("form").find("[type=submit]").addClass("bp-show"):i(e.target).closest("form").submit()},setSearchTerms:function(e){e.preventDefault(),this.model.set({search_terms:i(e.target).find("input[type=search]").val()||"",page:1})},nextPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")+1)},prevPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")-1)}}),bp.Views.inviteUsers=bp.Nouveau.GroupInvites.View.extend({tagName:"ul",className:"item-list bp-list",id:"members-list",initialize:function(){this.requestUsers(),this.collection.on("reset",this.cleanContent,this),this.collection.on("add",this.addUser,this)},requestUsers:function(){this.collection.reset(),this.collection.fetch({data:_.pick(this.options,"scope"),success:this.usersFetched,error:this.usersFetchError})},usersFetched:function(e,i){bp.Nouveau.GroupInvites.displayFeedback(i.feedback,"help")},usersFetchError:function(e,i){var t=i.type||"help";bp.Nouveau.GroupInvites.displayFeedback(i.feedback,t)},cleanContent:function(){_.each(this.views._views[""],function(e){e.remove()})},addUser:function(e){this.views.add(new bp.Views.inviteUser({model:e}))}}),bp.Views.inviteUser=bp.Nouveau.GroupInvites.View.extend({tagName:"li",template:bp.template("bp-invites-users"),events:{"click .group-add-remove-invite-button":"toggleUser","click .group-remove-invite-button":"removeInvite"},initialize:function(){bp.Nouveau.GroupInvites.invites.get(this.model.get("id"))&&(this.el.className="selected",this.model.set("selected",!0,{silent:!0}))},toggleUser:function(e){e.preventDefault(),!1===this.model.get("selected")?(this.model.set("selected",!0),i(this.el).addClass("selected")):(this.model.set("selected",!1),i(this.el).removeClass("selected"),bp.Nouveau.GroupInvites.invites.length||bp.Nouveau.GroupInvites.invites.reset())},removeInvite:function(e){e.preventDefault();var i=this.model.collection;i.length&&i.sync("delete",this.model.get("id"),{success:_.bind(this.inviteRemoved,this),error:_.bind(this.uninviteError,this)})},inviteRemoved:function(e){var i=this.model.collection;i.length&&(i.remove(this.model),this.remove(),bp.Nouveau.GroupInvites.removeFeedback(),!1===e.has_invites&&(bp.Nouveau.GroupInvites.displayFeedback(e.feedback,"success"),bp.Nouveau.GroupInvites.navItems.get("invited").set({active:0,hide:1})))},uninviteError:function(e){bp.Nouveau.GroupInvites.displayFeedback(e.feedback,"error")}}),bp.Views.invitesEditor=bp.Nouveau.GroupInvites.View.extend({tagName:"div",id:"send-invites-editor",events:{"click #bp-invites-send":"sendInvites","click #bp-invites-reset":"clearForm"},initialize:function(){this.views.add(new bp.Views.selectedUsers({collection:this.collection})),this.views.add(new bp.Views.invitesForm),this.collection.on("reset",this.cleanViews,this)},sendInvites:function(e){e.preventDefault(),i(this.el).addClass("bp-hide"),this.collection.sync("create",_.pluck(this.collection.models,"id"),{success:_.bind(this.invitesSent,this),error:_.bind(this.invitesError,this),data:{message:i(this.el).find("textarea").val()}})},invitesSent:function(e){this.collection.reset(),bp.Nouveau.GroupInvites.displayFeedback(e.feedback,"success"),1!==bp.Nouveau.GroupInvites.navItems.get("invited").get("hide")||BP_Nouveau.group_invites.is_group_create||bp.Nouveau.GroupInvites.navItems.get("invited").set({active:0,hide:0})},invitesError:function(e){var t=e.type||"help";i(this.el).removeClass("bp-hide"),bp.Nouveau.GroupInvites.displayFeedback(e.feedback,t),_.isUndefined(e.users)||(1===bp.Nouveau.GroupInvites.navItems.get("invited").get("hide")&&e.users.length<this.collection.length&&bp.Nouveau.GroupInvites.navItems.get("invited").set({active:0,hide:0}),_.each(this.collection.models,function(i){-1===_.indexOf(e.users,i.get("id"))&&i.set("selected",!1)},this))},clearForm:function(e){e.preventDefault(),this.collection.reset()},cleanViews:function(){_.each(this.views._views[""],function(e){e.remove()}),bp.Nouveau.GroupInvites.displayFeedback(BP_Nouveau.group_invites.invites_form_reset,"help")}}),bp.Views.invitesForm=bp.Nouveau.GroupInvites.View.extend({tagName:"div",id:"bp-send-invites-form",template:bp.template("bp-invites-form")}),bp.Views.selectedUsers=bp.Nouveau.GroupInvites.View.extend({tagName:"ul",initialize:function(){this.cleanContent(),_.each(this.collection.models,function(e){this.views.add(new bp.Views.selectedUser({model:e}))},this)},cleanContent:function(){_.each(this.views._views[""],function(e){e.remove()})}}),bp.Views.selectedUser=bp.Nouveau.GroupInvites.View.extend({tagName:"li",template:bp.template("bp-invites-selection"),events:{click:"removeSelection"},initialize:function(){this.model.on("change:selected",this.removeView,this)},removeSelection:function(e){e.preventDefault(),this.model.set("selected",!1)},removeView:function(e){!1===e.get("selected")&&this.remove()}}),bp.Nouveau.GroupInvites.start())}(bp,jQuery);